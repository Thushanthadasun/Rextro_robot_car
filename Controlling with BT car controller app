#include "BluetoothSerial.h" 
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <Adafruit_NeoPixel.h>


BluetoothSerial ESP_BT; // Bluetooth object

// ===========================
// OLED SETUP
// ===========================
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
const uint16_t num_leds = 2;  // Two NeoPixels (U6 + U7)
#define LED_PIN 14
Adafruit_NeoPixel strip(num_leds, LED_PIN, NEO_GRB + NEO_KHZ800);

#define OLED_RESET 4
Adafruit_SSD1306 display(128, 64, &Wire, OLED_RESET);

// ===========================
// MOTOR PINS
// ===========================
int M1A = 17; 
int M1B = 16;
int M2A = 18;
int M2B = 27;

// ===========================
// LED & BUZZER PINS
// ===========================
int LED1 = 2;
int LED2 = 15;
int BUZZER = 25;

// ===========================
// ULTRASONIC (single pin)
// ===========================
int US_PIN = 5;
long distanceCM = 0;
unsigned long lastUltrasonic = 0;

// ===========================
// SPEED & TIMING
// ===========================
int motorSpeed = 255;
unsigned long lastCommand = 0;
const unsigned long TIMEOUT = 50;

// Non-blocking horn/LED flash
unsigned long hornStartTime = 0;
bool hornActive = false;

struct FlashingLED {
  int pin;
  bool state;
  unsigned long lastToggle;
  int flashesRemaining;
  unsigned long interval;
} flashTail;

// ===========================
// SPLASH SCREEN LOGO
// ===========================
// 'rextro2025_logo', 128x64px
const unsigned char epd_bitmap_rextro2025_logo [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xf8, 0x1f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfc, 0x3f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xfc, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x03, 0xff, 0xf0, 0xff, 0xf1, 0xfd, 0xfe, 0x3f, 0xfc, 0xff, 0xfc, 0x1f, 0xff, 0x00, 0x00, 
	0x00, 0x03, 0xff, 0xfc, 0xff, 0xf0, 0xff, 0xfc, 0x03, 0x80, 0xff, 0xfe, 0x78, 0x07, 0x80, 0x00, 
	0x00, 0x03, 0xc0, 0x1c, 0xe0, 0x00, 0x3f, 0xf0, 0x03, 0x80, 0xe0, 0x0e, 0x70, 0x03, 0x80, 0x00, 
	0x00, 0x03, 0x9f, 0xfc, 0xe7, 0xe0, 0x3f, 0xf0, 0x03, 0x80, 0xe3, 0xfe, 0x70, 0x03, 0xc0, 0x00, 
	0x00, 0x03, 0x8f, 0xf0, 0xe0, 0x00, 0x7f, 0xf8, 0x03, 0x80, 0xe3, 0xfc, 0x70, 0x03, 0x80, 0x00, 
	0x00, 0x03, 0xc0, 0x78, 0xff, 0xf0, 0xff, 0xfe, 0x03, 0x80, 0xe0, 0x1c, 0x7f, 0xff, 0x80, 0x00, 
	0x00, 0x03, 0x80, 0x3c, 0xff, 0xe3, 0xfc, 0x7f, 0x03, 0x80, 0xe0, 0x0e, 0x1f, 0xfe, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xf8, 0x7f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf0, 0x7f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x58, 0x12, 0x49, 0x4c, 0x95, 0x9a, 0x01, 0x8a, 0x92, 0x8c, 0x10, 0x26, 0x80, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// Array of all bitmaps for convenience. (Total bytes used to store images in PROGMEM = 1040)
const int epd_bitmap_allArray_LEN = 1;
const unsigned char* epd_bitmap_allArray[1] = {
	epd_bitmap_rextro2025_logo
};



// ===========================
// DISPLAY FUNCTION WITH DISTANCE INCLUDED
// ===========================
void ShowMessage(String msg) {
  display.clearDisplay();

  // Main message
  display.setTextSize(2);
  display.setTextColor(WHITE);
  display.setCursor(5, 5);
  display.println(msg);

  // Distance line
  display.setTextSize(1);
  display.setCursor(5, 45);
  display.print("Distance: ");
  display.print(distanceCM);
  display.println(" cm");

  display.display();
}

// ===========================
// SINGLE-PIN ULTRASONIC READER (non-blocking safe)
// ===========================
long ReadUltrasonic() {
  pinMode(US_PIN, OUTPUT);
  digitalWrite(US_PIN, LOW);
  delayMicroseconds(3);
  digitalWrite(US_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(US_PIN, LOW);

  pinMode(US_PIN, INPUT);
  long duration = pulseIn(US_PIN, HIGH, 25000); // 25ms timeout (max ~4m)

  long dist = duration / 58;
  if (dist <= 0 || dist > 400) dist = 0; // invalid reading
  return dist;
}

// ===========================
// MOTOR FUNCTIONS
// ===========================
void StopMotors() {
  analogWrite(M1A, 0); analogWrite(M1B, 0);
  analogWrite(M2A, 0); analogWrite(M2B, 0);
  ShowMessage("STOP");
}

void Backward() {
  analogWrite(M1A, motorSpeed); analogWrite(M1B, 0);
  analogWrite(M2A, motorSpeed); analogWrite(M2B, 0);
  ShowMessage("BACKWARD");
}

void Forward() {
  analogWrite(M1B, motorSpeed); analogWrite(M1A, 0);
  analogWrite(M2B, motorSpeed); analogWrite(M2A, 0);
  ShowMessage("FORWARD");
}

void SmoothLeft() {
  int turnSpeed = 255;
  analogWrite(M1A, 0);
  analogWrite(M1B, turnSpeed);
  analogWrite(M2A, turnSpeed);
  analogWrite(M2B, 0);
  ShowMessage("LEFT");
}

void SmoothRight() {
  int turnSpeed = 255;
  analogWrite(M1A, turnSpeed);
  analogWrite(M1B, 0);
  analogWrite(M2A, 0);
  analogWrite(M2B, turnSpeed);
  ShowMessage("RIGHT");
}

void LED_ON() {
  digitalWrite(LED1,HIGH);
  digitalWrite(LED2,HIGH);
  ShowMessage("LED ON");
}

void LED_OFF() {
  digitalWrite(LED1,LOW);
  digitalWrite(LED2,LOW);
  ShowMessage("LED OFF");
}

void Beep() {
  hornActive = true;
  hornStartTime = millis();
  ShowMessage("BEEP");
}

// ===========================
// SETUP
// ===========================
void setup() {
  Serial.begin(9600);

  // OLED INIT
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println("SSD1306 failed");
    for(;;);
    strip.begin();
strip.show();  // Turn off all LEDs initially

  }

  display.clearDisplay();

  // === Show splash screen logo ===
  display.drawBitmap(0, 0, epd_bitmap_rextro2025_logo, SCREEN_WIDTH, SCREEN_HEIGHT, WHITE);
  display.display();
  delay(10000); // display for 2 seconds

  // === Initialize robot hardware ===
  ESP_BT.begin("DP_Robot2");

  pinMode(M1A, OUTPUT); pinMode(M1B, OUTPUT);
  pinMode(M2A, OUTPUT); pinMode(M2B, OUTPUT);
  pinMode(LED1, OUTPUT); pinMode(LED2, OUTPUT);
  pinMode(BUZZER, OUTPUT);

  StopMotors();

  flashTail.pin = LED2;
  flashTail.interval = 500;
}

// ===========================
// LOOP
// ===========================
void loop() {
  for(int i = 0; i < num_leds; i++){
    strip.setPixelColor(i, strip.Color(255, 255, 255)); // White
}
strip.show();

  // ===== READ DISTANCE EVERY 100ms =====
  if (millis() - lastUltrasonic >= 100) {
    distanceCM = ReadUltrasonic();
    lastUltrasonic = millis();
  }

  // ===== BLUETOOTH COMMANDS =====
  if (ESP_BT.available()) {
    char cmd = ESP_BT.read();
    lastCommand = millis();

    switch(cmd) {
      case 'F': Forward(); break;
      case 'B': Backward(); break;
      case 'L': SmoothLeft(); break;
      case 'R': SmoothRight(); break;
      case 'S': StopMotors(); break;

      case '1': motorSpeed=100; break;
      case '2': motorSpeed=150; break;
      case '3': motorSpeed=200; break;
      case '4': motorSpeed=250; break;

      case 'U': LED_ON(); break;
      case 'u': LED_OFF(); break;

      case 'X': flashTail.flashesRemaining=6;
                flashTail.lastToggle=millis();
                break;

      case 'Y': Beep(); break;
    }
  }

  // ===== AUTO STOP =====
  if (millis() - lastCommand > TIMEOUT) StopMotors();

  // ===== TWO-TONE HORN =====
  if(hornActive) {
    unsigned long t = millis() - hornStartTime;
    if(t < 200) tone(BUZZER, 1200);
    else if(t < 400) tone(BUZZER, 800);
    else { noTone(BUZZER); hornActive=false; }
  }

  // ===== TAIL LED FLASH =====
  if (flashTail.flashesRemaining>0 &&
      millis()-flashTail.lastToggle >= flashTail.interval) {
    digitalWrite(flashTail.pin, !digitalRead(flashTail.pin));
    flashTail.lastToggle = millis();
    flashTail.flashesRemaining--;
  }
}

