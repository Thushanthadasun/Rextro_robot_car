/*
 * DPBot PRO Controller (ESP32) - Full Duplex
 * Modified: Added Boot Bars + Live Status Bars + RGB Display
 * UPDATE: Forward/Backward Logic Interchanged
 */

#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>
#include <BLE2902.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <Adafruit_NeoPixel.h>
#include <DHT.h>

// --- PIN CONFIGURATION ---
// Motors
const int M1A = 16; const int M1B = 17; // Left Motor
const int M2A = 18; const int M2B = 27; // Right Motor

// Components
#define PIN_RGB     14  
#define PIN_DHT     26  
#define PIN_US      5    // Single Pin for Ultrasonic (Trigger + Echo)

// Headlights (Dual Pins)
#define PIN_LIGHT_1 15   // Headlight A
#define PIN_LIGHT_2 2    // Headlight B

// --- OBJECTS & SETTINGS ---
#define DHTTYPE DHT11
DHT dht(PIN_DHT, DHTTYPE);

#define NUMPIXELS 2 
Adafruit_NeoPixel pixels(NUMPIXELS, PIN_RGB, NEO_GRB + NEO_KHZ800);

// OLED
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
Adafruit_SSD1306 oled(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// BLE UUIDs
#define BLE_NAME "DPBot Pro #2"
#define SERVICE_UUID        "4fafc201-1fb5-459e-8fcc-c5c9c331914b"
#define CHAR_UUID           "beb5483e-36e1-4688-b7f5-ea07361b26a8"

// Variables
BLECharacteristic *pCharacteristic;
bool deviceConnected = false;
unsigned long lastCommandTime = 0;
unsigned long lastSensorRead = 0;

// Input State
int8_t valFwd = 0;
int8_t valTurn = 0;
uint8_t valR = 0, valG = 0, valB = 0;
uint8_t valLight = 0;

// Sensor State
int currentDist = 0; 
int currentTemp = 0;

// PWM Channels
const int ch_M1A = 0; const int ch_M1B = 1;
const int ch_M2A = 2; const int ch_M2B = 3;

// --- BOOT LOGO (Robot Face) ---
const unsigned char epd_bitmap_Logo [] PROGMEM = {
  	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xf8, 0x1f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfc, 0x3f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xfc, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x03, 0xff, 0xf0, 0xff, 0xf1, 0xfd, 0xfe, 0x3f, 0xfc, 0xff, 0xfc, 0x1f, 0xff, 0x00, 0x00, 
	0x00, 0x03, 0xff, 0xfc, 0xff, 0xf0, 0xff, 0xfc, 0x03, 0x80, 0xff, 0xfe, 0x78, 0x07, 0x80, 0x00, 
	0x00, 0x03, 0xc0, 0x1c, 0xe0, 0x00, 0x3f, 0xf0, 0x03, 0x80, 0xe0, 0x0e, 0x70, 0x03, 0x80, 0x00, 
	0x00, 0x03, 0x9f, 0xfc, 0xe7, 0xe0, 0x3f, 0xf0, 0x03, 0x80, 0xe3, 0xfe, 0x70, 0x03, 0xc0, 0x00, 
	0x00, 0x03, 0x8f, 0xf0, 0xe0, 0x00, 0x7f, 0xf8, 0x03, 0x80, 0xe3, 0xfc, 0x70, 0x03, 0x80, 0x00, 
	0x00, 0x03, 0xc0, 0x78, 0xff, 0xf0, 0xff, 0xfe, 0x03, 0x80, 0xe0, 0x1c, 0x7f, 0xff, 0x80, 0x00, 
	0x00, 0x03, 0x80, 0x3c, 0xff, 0xe3, 0xfc, 0x7f, 0x03, 0x80, 0xe0, 0x0e, 0x1f, 0xfe, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xf8, 0x7f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf0, 0x7f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x58, 0x12, 0x49, 0x4c, 0x95, 0x9a, 0x01, 0x8a, 0x92, 0x8c, 0x10, 0x26, 0x80, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// --- MOTOR LOGIC ---
void updateMotors(int8_t fwd, int8_t turn) {
  // --- INVERT FORWARD/BACKWARD LOGIC ---
  fwd = -fwd; 
  // -------------------------------------

  const bool invertLeft = true;   
  const bool invertRight = false; 

  int left = fwd + turn;
  int right = fwd - turn;

  if (invertLeft) left = -left;
  if (invertRight) right = -right;

  left = constrain(left, -100, 100);
  right = constrain(right, -100, 100);

  int pwmLeft = map(abs(left), 0, 100, 0, 255);
  int pwmRight = map(abs(right), 0, 100, 0, 255);

  if (pwmLeft < 50 && pwmLeft > 0) pwmLeft = 50;
  if (pwmRight < 50 && pwmRight > 0) pwmRight = 50;

  if (left > 0) { ledcWrite(ch_M1A, pwmLeft); ledcWrite(ch_M1B, 0); } 
  else if (left < 0) { ledcWrite(ch_M1A, 0); ledcWrite(ch_M1B, pwmLeft); } 
  else { ledcWrite(ch_M1A, 0); ledcWrite(ch_M1B, 0); }

  if (right > 0) { ledcWrite(ch_M2A, pwmRight); ledcWrite(ch_M2B, 0); } 
  else if (right < 0) { ledcWrite(ch_M2A, 0); ledcWrite(ch_M2B, pwmRight); } 
  else { ledcWrite(ch_M2A, 0); ledcWrite(ch_M2B, 0); }
}

void stopMotors() {
  ledcWrite(ch_M1A, 0); ledcWrite(ch_M1B, 0);
  ledcWrite(ch_M2A, 0); ledcWrite(ch_M2B, 0);
  valFwd = 0; valTurn = 0;
}

// --- SENSOR LOGIC (SINGLE PIN MODE) ---
long readDistance() {
  pinMode(PIN_US, OUTPUT);
  digitalWrite(PIN_US, LOW);
  delayMicroseconds(2);
  digitalWrite(PIN_US, HIGH);
  delayMicroseconds(10);
  digitalWrite(PIN_US, LOW);
  
  pinMode(PIN_US, INPUT);
  long duration = pulseIn(PIN_US, HIGH, 30000);
  if (duration == 0) return 0; // Timeout
  return duration * 0.034 / 2;
}

// --- DISPLAY LOGIC (BARS + STATUS) ---
void showStartup() {
    oled.clearDisplay();
    oled.setTextSize(1);
    oled.setTextColor(WHITE);

    // --- Bar 1: OLED Initialization ---
    oled.setCursor(0,0); oled.println("Initializing OLED...");
    for (int i=0; i<=128; i+=8) {
        oled.drawRect(0, 16, 128, 10, WHITE);
        oled.fillRect(0, 16, i, 10, WHITE);
        oled.display(); 
        delay(20); 
    }
    delay(100);

    // --- Bar 2: BLE Initialization ---
    oled.clearDisplay();
    oled.setCursor(0,0); oled.println("Starting BLE...");
    for (int i=0; i<=128; i+=8) {
        oled.drawRect(0, 16, 128, 10, WHITE);
        oled.fillRect(0, 16, i, 10, WHITE);
        oled.display(); 
        delay(20); 
    }
    delay(200);

    // --- Robot Face Logo ---
    oled.clearDisplay();
    oled.drawBitmap(0, 0, epd_bitmap_Logo, 128, 64, WHITE);
    oled.display();
    delay(1000); // Show logo for 1 sec
    oled.clearDisplay();
}

void drawStatus() {
    oled.clearDisplay();
    
    // Status Text
    oled.setTextSize(1);
    oled.setTextColor(WHITE);
    oled.setCursor(0,0); 
    oled.println(deviceConnected ? "CONNECTED" : "SCANNING..."); 
    oled.drawLine(0, 10, 128, 10, WHITE); 
    
    // Numeric Values
    oled.setCursor(0,16); oled.printf("FWD:  %d", valFwd);
    oled.setCursor(0,28); oled.printf("TURN: %d", valTurn);

    // Calculate Bar Widths (0-100 mapped to 0-60px)
    int fwdBar = map(abs(valFwd), 0, 100, 0, 60);
    int turnBar = map(abs(valTurn), 0, 100, 0, 60);

    // Draw FWD Bar (Right Side)
    oled.drawRect(64, 16, 62, 6, WHITE);
    oled.fillRect(66, 18, fwdBar, 2, WHITE);

    // Draw TURN Bar (Right Side)
    oled.drawRect(64, 28, 62, 6, WHITE);
    oled.fillRect(66, 30, turnBar, 2, WHITE);

    // RGB Status (Bottom)
    oled.setCursor(0,50); 
    oled.printf("RGB: %d %d %d", valR, valG, valB);

    oled.display();
}

// --- BLE CALLBACKS ---
class ServerCallbacks: public BLEServerCallbacks {
    void onConnect(BLEServer* pServer) { deviceConnected = true; }
    void onDisconnect(BLEServer* pServer) { 
      deviceConnected = false; 
      stopMotors(); 
      BLEDevice::startAdvertising(); 
    }
};

class CharacteristicCallbacks: public BLECharacteristicCallbacks {
    void onWrite(BLECharacteristic *pCharacteristic) {
      std::string value = pCharacteristic->getValue();
      
      // NEW PROTOCOL: 7 Bytes
      if (value.length() == 7) {
        if ((uint8_t)value[0] == 0xFF) {
          lastCommandTime = millis();
          
          // 1. Motor Data
          valFwd = (int8_t)value[1]; 
          valTurn = (int8_t)value[2];
          updateMotors(valFwd, valTurn);

          // 2. RGB LED Data
          valR = (uint8_t)value[3];
          valG = (uint8_t)value[4];
          valB = (uint8_t)value[5];
          for(int i=0; i<NUMPIXELS; i++) {
            pixels.setPixelColor(i, pixels.Color(valR, valG, valB));
          }
          pixels.show();

          // 3. Headlight Data (Pins 15 & 2)
          valLight = (uint8_t)value[6];
          int pinState = valLight ? HIGH : LOW;
          digitalWrite(PIN_LIGHT_1, pinState);
          digitalWrite(PIN_LIGHT_2, pinState);
        }
      }
    }
};

// --- SETUP ---
void setup() {
  Serial.begin(115200);

  // Initialize Light Pins
  pinMode(PIN_LIGHT_1, OUTPUT);
  pinMode(PIN_LIGHT_2, OUTPUT);
  
  // Initialize Components
  dht.begin();
  pixels.begin();
  pixels.setBrightness(255);
  pixels.show(); // Off

  // Initialize Motors
  ledcSetup(ch_M1A, 2000, 8); ledcSetup(ch_M1B, 2000, 8);
  ledcSetup(ch_M2A, 2000, 8); ledcSetup(ch_M2B, 2000, 8);
  ledcAttachPin(M1A, ch_M1A); ledcAttachPin(M1B, ch_M1B);
  ledcAttachPin(M2A, ch_M2A); ledcAttachPin(M2B, ch_M2B);

  // Initialize OLED
  Wire.begin();
  if(!oled.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
      Serial.println("SSD1306 allocation failed");
      for(;;);
  }

  // --- SHOW BOOT BARS & LOGO ---
  showStartup();

  // Initialize BLE
  BLEDevice::init(BLE_NAME);
  BLEServer *pServer = BLEDevice::createServer();
  pServer->setCallbacks(new ServerCallbacks());
  BLEService *pService = pServer->createService(SERVICE_UUID);
  pCharacteristic = pService->createCharacteristic(
                                   CHAR_UUID,
                                   BLECharacteristic::PROPERTY_READ |
                                   BLECharacteristic::PROPERTY_WRITE |
                                   BLECharacteristic::PROPERTY_WRITE_NR |
                                   BLECharacteristic::PROPERTY_NOTIFY
                                 );
  pCharacteristic->setCallbacks(new CharacteristicCallbacks());
  pCharacteristic->addDescriptor(new BLE2902());
  pService->start();
  
  BLEAdvertising *pAdvertising = BLEDevice::getAdvertising();
  pAdvertising->addServiceUUID(SERVICE_UUID);
  pAdvertising->setScanResponse(true);
  pAdvertising->setMinPreferred(0x06);  
  BLEDevice::startAdvertising();
}

// --- LOOP ---
void loop() {
  // Safety Timeout
  if (deviceConnected && (millis() - lastCommandTime > 500)) {
    if (valFwd != 0 || valTurn != 0) stopMotors();
  }

  // Sensor Read & Notify Loop (Every 200ms)
  if (millis() - lastSensorRead > 200) {
    if (deviceConnected) {
      // 1. Read Sensors (Once per loop to allow Single Pin switch time)
      currentDist = (int)readDistance();
      currentTemp = (int)dht.readTemperature();
      if (isnan(currentTemp)) currentTemp = 0;

      // 2. Prepare Packet [Dist, Temp]
      uint8_t sensorData[2];
      sensorData[0] = (uint8_t) constrain(currentDist, 0, 255);
      sensorData[1] = (uint8_t) constrain(currentTemp, 0, 255);

      // 3. Notify Phone
      pCharacteristic->setValue(sensorData, 2);
      pCharacteristic->notify();
    } else {
      // Read sensors even if not connected (optional, if you want local logic later)
      currentDist = (int)readDistance();
      currentTemp = (int)dht.readTemperature();
    }
    lastSensorRead = millis();
  }

  // --- OLED Display Update (Every 50ms) ---
  static unsigned long lastDraw = 0;
  if(millis() - lastDraw > 50) {
      drawStatus();
      lastDraw = millis();
  }
}